{% extends "base.html" %}
{% load static %}

{% block content %}


<div style="background-color: #262626">
	<div class="container special-container">
	   <p style="color:white; font-size: 40px; font-weight: bold">PU Palette</p>
		 <div style="width: 75%">
		   <p style="color:#BDBDBD; font-size: 12px; font-weight: 300">Explore the use of color in the Princeton University Art Museum's collection, over time and around the world! Select or text input a date and color, and watch the map light up with results. Click into countries to view artworks.  </p>
		</div>
	</div>

	<div class = "container">
		<div class="row" style="padding-bottom:20px">
			<!-- date slider -->
			<div class = "column" style="flex:55%">
				<p class = "inputlabel">Date</p>
				<input class = "inputbox" id="sliderInput"></input>
				<div class="slidecontainer">
		 			<input type="range" min="0" max="12" value="8" class="slider" id="slider">
				</div>
			</div>

			<!-- space between -->
			<div class = "column" style="flex:5%"> </div>

			<!-- color + hex -->
			<div class = "column" style="flex:10%">
				<p class = "inputlabel">Color </p>
				<input class = "inputbox" id="hexval"></input>
				
			</div>

			<!-- space between -->
			<!-- <div class = "column" style="flex:5%"> </div> -->

			<!-- color circle -->
			<div class = "column" style="flex:30%">
				<div id = "circle" class = "circle" onclick="showPicker()"></div>
				<div class="ColorPicker" id="boxPicker" style="display:none; position: absolute; padding-top: 10px; ">
		        </div>

			</div>

		</div>
	</div> 

	<div class = "loader" id="loader" style="display: none;"></div>
</div>



<div class = "container special-container" style="padding-bottom: 0;">
 	<object data = "{% static 'worldmap.svg'%}" id="alphasvg" type = "image/svg+xml" width = "100%" ></object>
</div>

	<script>

// ESSENTIAL VARIABLES & FUNCTIONS//
// maybe change Cote d Ivoire
	// Country IDs ** missing some countries in the svg map (refer to google doc) 

		let mapids = ['Canada', 'Mexico', 'Peru', 'Ecuador', 'Ethiopia', 'Japan', 'China', 'Netherlands', 'United_States', 'Austria', 'Italy', 'UK', 'Egypt', 'Indonesia', 'Belgium', 'Syria', 'Israel', 'Cote_d_Ivoire', 'Lebanon', 'France', 'Germany', 'Spain', 'Australia', 'Greece', 'Colombia', 'Switzerland', 'Denmark', 'Sri_Lanka', 'Thailand', 'Cambodia', 'Panama', 'Samoa', 'Algeria', 'Tibet', 'Guatemala', 'Turkey', 'Nigeria', 'Serbia', 'Portugal', 'Ireland', 'Norway', 'Democratic_Republic_of_the_Congo', 'India', 'Afghanistan', 'Palestine', 'Iran', 'French_Polynesia', 'Sweden', 'Kenya', 'Vietnam', 'Ukraine', 'Brazil', 'Nicaragua', 'Korea', 'Cyprus', 'Iraq', 'Russia', 'Bolivia', 'Tunisia', 'Costa_Rica', 'Argentina', 'Angola', 'Jordan', 'Nepal', 'Pakistan', 'Ghana', 'Mali', 'Gabon', 'St._Lucia', 'El_Salvador', 'Papua_New_Guinea', 'Honduras', 'Belize', 'Burkina_Faso', 'Cameroon', 'Cuba', 'Liberia', 'Chile', 'Guinea', 'Grenada', 'Romania', 'Hungary', 'New_Caledonia', 'Tanzania', 'Madagascar', 'Zimbabwe', 'Central_African_Republic', 'Dominican_Republic', 'Rwanda', 'South_Africa', 'Solomon_Islands', 'Fiji', 'Myanmar', 'Uruguay', 'Sierra_Leone', 'Venezuela', 'Morocco', 'Benin', 'Bermuda', 'Philippines', 'Poland', 'Croatia', 'Mongolia']

		let searchObjectIDs = new Array(mapids.length)
		let searchColors = new Array(mapids.length)
		let searchCounts = new Array(mapids.length)


		var slider = document.getElementById("slider");
		var sliderInput = document.getElementById("sliderInput");
		var hexval = document.getElementById("hexval");
		var circle = document.getElementById("circle");


		let colorVAR = null;
		let color = null;
		let most = null;
		let few = '#545454'
		let none = '#333333'

		slider.value = 9
		sliderInput.value = "1800-1849";
		circle.style.backgroundColor = "#b86a32";
		hexval.value ="#b86a32"



	// Function determining color based on frequency of artworks
		function getColor(value, svgDoc, mapid) {
			if (value > 20) {
				color = most
				svgDoc.getElementById(mapid).style.fill = color
			}
			else if (value > 0 && value <= 20){
				svgDoc.getElementById(mapid).style.fill = few
			}
			else if (value == 0){
				svgDoc.getElementById(mapid).style.fill = none
			}
			//return color
		}

	// Get range of dates in string form (for colorMap function)
		function getRange(val) {
			range = [];
			low = "";
			high = "";

			if (val == 0){low = "-15000"; high ="-2001"}
			else if (val == 1) {low ="-2000"; high = "-1001"}
			else if (val == 2) {low = "-1000"; high ="0"}
			else if (val == 3) {low = "1"; high ="499"}
			else if (val == 4) {low = "500"; high = "999"}
			else if (val == 5) {low = "1000"; high = "1499"}
			else if (val == 6) {low = "1500"; high = "1599"}
			else if (val == 7) {low = "1600"; high = "1699"}
			else if (val == 8) {low = "1700"; high = "1799"}
			else if (val == 9) {low = "1800"; high = "1849"}
			else if (val == 10) {low = "1850"; high = "1899"}
			else if (val == 11) {low = "1900"; high = "1944"}
			else if (val == 12) {low = "1945"; high = "2021"}

			range.push(low);
			range.push(high);

			return range
		}


	/*	var value1="value1";
		var value2="value2";
		var queryString = "?para1=" + value1 + "&para2=" + value2;
		window.location.href = "country" + queryString*/

		// <a id="mylink" xlink:href="\country\" target="_top"></a>


	// Function to color the map accordingly 
		function searchFunc(rangeStr, rgbStr, mapidsStr, callback){
			$.ajax({
			  type: "GET",
			  url: "/colorSearch/",  // figure out how to link to colorSearch.py!!
			  data: { 
			  	csrfmiddlewaretoken: '{{ csrf_token }}',
			  	searchRGB: rgbStr,
			  	dateRange: rangeStr,
			  	mapIDs: mapidsStr},
			  beforeSend: function(){
			  	$("#loader").show();
			  },
			  success: callback,
			  complete: function(data) {
			  	
			  }
			});
		} 



//https://www.codeproject.com/Questions/795191/Passing-JavaScript-data-values-between-HTML-pages
	
		function colorMap(svgDoc) {
	  		let rangeStr = getRange(slider.value).toString()
			let rgbStr = circle.style.backgroundColor.match(/\d+/g).toString()
			let mapidsStr = mapids.toString()

			searchFunc(rangeStr, rgbStr, mapidsStr, function(response){

				if (rangeStr != getRange(slider.value).toString()) return;
				if (rgbStr != circle.style.backgroundColor.match(/\d+/g).toString()) return;

				searchCounts = response[0];
			  	searchObjectIDs = response[1];
			  	searchImageURLs = response[2];
			  	for (i = 0; i < mapids.length; i++) {
			  		getColor(searchCounts[i], svgDoc, mapids[i])
			  		var country = svgDoc.getElementById(mapids[i])

			  		let queryString = "?" + rangeStr + "&" + rgbStr + "&" + mapids[i];
					let dest = "/country/" + queryString

					let linkID = mapids[i] + "link"
					let link = svgDoc.getElementById(linkID);
					link.setAttribute('href', dest);
			  	}
			  	$("#loader").hide();
			});
		}

// COLOR PICKER //
// iro.js//
	// Toggles showing color picker on click of circle
		function showPicker() {
		  var x = document.getElementById("boxPicker");
		  if (x.style.display === "none") {
		    x.style.display = "block";
		  } else {
		    x.style.display = "none";
		  }
		}

	// Box & hue slider from iro.js 
		var boxPicker = new iro.ColorPicker("#boxPicker", {
		  width: 125,
		  color: "rgb(197, 107, 42)",
		  borderWidth: 0,
		  borderColor: "#262626",
		  layout: [
		    {
		      component: iro.ui.Box,
		    },
		    {
		      component: iro.ui.Slider,
		      options: {
		        sliderType: 'hue'
		      }
		    }
		  ]
		});


// ONCHANGE EVENTS

		var a = document.getElementById("alphasvg");
	    a.addEventListener("load",function(){
	    	most = circle.style.backgroundColor
	       // get the inner DOM of alpha.svg
            var svgDoc = a.contentDocument;
            svgDoc.getElementById('Most').style.fill = most

			const NamSpace= 'http://www.w3.org/2000/svg';


            for (i = 0; i < mapids.length; i++) {
			  		getColor(searchCounts[i], svgDoc, mapids[i])
			  		var country = svgDoc.getElementById(mapids[i])

			  		let el= svgDoc.getElementById(mapids[i]);
				    const wrapper = document.createElementNS(NamSpace,'a');
				    wrapper.setAttribute('href', "/country/");
				    wrapper.setAttribute('target', '_parent')
				    linkID = mapids[i] + "link"
				    wrapper.setAttribute('id', linkID)
				    el.parentNode.insertBefore(wrapper, el);
				    el.parentNode.removeChild(el);
				    wrapper.appendChild(el);
			 }

			// Fills circle and adjust box/hue slider colors & position with hex input
			hexval.onchange = function() {
				circle.style.backgroundColor = this.value;
				boxPicker.addColor(this.value);
				boxPicker.removeColor(0);
				most = circle.style.backgroundColor;
				svgDoc.getElementById('Most').style.fill = most
				colorMap(svgDoc)
			}

			boxPicker.on(["color:init"], function(color) {
			 	colorMap(svgDoc)
			});

			boxPicker.on(["color:change"], function(color){
			  hexval.value = color.hexString;
			  circle.style.backgroundColor = color.hexString;
			  most = circle.style.backgroundColor;
			});

			boxPicker.on(["input:end"], function(input) {
			 	colorMap(svgDoc)
			 	svgDoc.getElementById('Most').style.fill = most
			});

			// changing the slider input based on slider location
		    slider.onchange = function () {
		    	colorMap(svgDoc)
			}
			slider.oninput = function () {
				val = this.value
		       	if (val == 0){date = "15000-2001 BC"}
				else if (val == 1) {date = "2000-1001 BC"}
				else if (val == 2) {date = "1000 BC - 0 AD"}
				else if (val == 3) {date = "1-499 AD"}
				else if (val == 4) {date = "500-999"}
				else if (val == 5) {date = "1000-1499"}
				else if (val == 6) {date = "1500-1599"}
				else if (val == 7) {date = "1600-1699"}
				else if (val == 8) {date = "1700-1799"}
				else if (val == 9) {date = "1800-1849"}
				else if (val == 10) {date = "1850-1899"}
				else if (val == 11) {date = "1900-1944"}
				else if (val == 12) {date = "1945-Present"}
				sliderInput.value = date;
			}

		    // changing the slider location based on input
			sliderInput.onchange = function () {
				val = this.value;
				if (val < -2000){date = "15000-2001 BC"; slider.value = 0;}
				else if (val >= -2000 && val <-1000) {date = "2000-1001 BC"; slider.value = 1;}
				else if (val >= -1000 && val <1) {date = "1000 BC - 0 AD"; slider.value = 2;}
				else if (val >= 1 && val <500) {date = "1-499 AD"; slider.value = 3;}
				else if (val >= 500 && val < 1000){date = "500-999"; slider.value = 4;}
				else if (val >= 1000 && val <1500) {date = "1000-1499"; slider.value = 5;}
				else if (val >= 1500 && val <1600) {date = "1500-1599"; slider.value = 6;}
				else if (val >= 1600 && val <1700) {date = "1600-1699"; slider.value = 7;}
				else if (val >= 1700 && val <1800) {date = "1700-1799"; slider.value = 8;}
				else if (val >= 1800 && val < 1850){date = "1800-1849"; slider.value = 9;}
				else if (val >= 1850 && val <1900) {date = "1850-1899"; slider.value = 10;}
				else if (val >= 1900 && val <1945) {date = "1900-1944"; slider.value = 11;}
				else if (val >= 1945) {date = "1945-Present"; slider.value = 12;}
				sliderInput.value = date;
				colorMap(svgDoc)
			}

	    }, false);
	   

		
	</script>
{% endblock %}

